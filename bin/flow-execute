#!/usr/bin/env bash

export HOME=`getent passwd $USER | cut -d':' -f6`
source ~/.bashrc

echo "Executing on $CLUSTER"

if [ "$CLUSTER" = "cedar" ]
then
    module load 'singularity/2.5'
    CONTAINER_HOME=$CONTAINER_HOME/$1
elif [ "$CLUSTER" = "graham" ]
then
    module load 'singularity/2.5'
    CONTAINER_HOME=$CONTAINER_HOME/$1
else
    if [ -z "${CONTAINER_HOME}" ]
    then
        echo "ERROR: unknown cluster. CONTAINER_HOME must be set"
        exit 1
    else
        CONTAINER_HOME=${CONTAINER_HOME}/$1
    fi
fi

# Pull only if it exists
sregistry pull $1

# Prepare mountings
echo "Certificate folder: ${CERTIFICATE_FOLDER}"

if [ -z "${CERTIFICATE_FOLDER}" ]
then
    echo 'Error: certificate folder not defined. Please set $CERTIFICATE_FOLDER'
    exit 1
fi

echo "Data folder: ${CONTAINER_DATA}"

if [ ! -d "${CONTAINER_DATA}" ]
then
    mkdir -p ${CONTAINER_DATA}
fi

# Replace : by - in pathname
CONTAINER_HOME=${CONTAINER_HOME//[:]/-}

echo "Container home: ${CONTAINER_HOME}"

if [ ! -d "${CONTAINER_HOME}/${USER}" ]
then
    echo "creating ${CONTAINER_HOME}/${USER}"
    mkdir -p ${CONTAINER_HOME}/${USER}
else
    echo "${CONTAINER_HOME}/${USER} already exists"
fi

if [ -z "${CONTAINER_CONFIG}" ]
then
    echo 'Error: Please set $CONTAINER_CONFIG'
    exit 1
fi

echo "Config dir: ${CONTAINER_CONFIG}"
if [ ! -d "${CONTAINER_CONFIG}" ]
then
    mkdir -p ${CONTAINER_CONFIG}
fi

# cp -r ${HOME}/.config ${CONTAINER_HOME}/${USER}/

# TODO: find a way to mount slurm executables
# See: https://groups.google.com/a/lbl.gov/forum/#!topic/singularity/syLcsIWWzdo


# run
SINGULARITYENV_DATA_PATH=/data \
    singularity exec \
        --bind ${CONTAINER_CONFIG}/:/config \
        --bind ${CERTIFICATE_FOLDER}/:/certs \
        --bind ${CONTAINER_DATA}/:/data \
        --bind ${CONTAINER_HOME}/:/home \
        --nv $(sregistry get $1) ${@:2}
