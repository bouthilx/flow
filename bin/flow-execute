#!/usr/bin/env bash

echo "Executing on $CLUSTER"

if [ "$CLUSTER" = "cedar" ]
then
    module load 'singularity/2.4'
    CONTAINER_HOME=$SCRATCH/$1
elif [ "$CLUSTER" = "graham" ]
then
    module load 'singularity/2.4'
    CONTAINER_HOME=$SCRATCH/$1
else
    echo "ERROR: unknown cluster"
    exit 1
fi

# Pull only if it exists
sregistry pull $1

# Prepare mountings
echo "Certificate folder: ${CERTIFICATE_FOLDER}"

if [ -z "${CERTIFICATE_FOLDER}" ]
then
    echo 'Error: certificate folder not defined. Please set $CERTIFICATE_FOLDER'
    exit 1
fi

echo "Data folder: ${DATA_FOLDER}"

if [ ! -d "${DATA_FOLDER}" ]
then
    mkdir -p ${DATA_FOLDER}
fi

echo "Container home: ${CONTAINER_HOME}"

if [ ! -d "${CONTAINER_HOME}" ]
then
    mkdir -p ${CONTAINER_HOME}
fi

# run
SINGULARITYENV_DATA_PATH=/data \
    singularity exec \
        --bind ${CERTIFICATE_FOLDER}/:/certs \
	--bind ${DATA_FOLDER}/:/data \
	--bind ${CONTAINER_HOME}/:/home \
	--nv $(sregistry get $1) ${@:2}
