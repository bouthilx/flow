#!/usr/bin/env bash

if [ -z "${GPU_SLURM_ACCOUNT}" ]
then
    echo 'Error: gpu slurm account not defined. Please set $GPU_SLURM_ACCOUNT'
    exit 1
fi

SBATCH_FILE=$1
CONTAINER=$2
ARGUMENTS=${@:3}

echo "Submitting ${SBATCH_FILE}"
echo "With container ${CONTAINER}"
echo "With arguments: ${ARGUMENTS}" 

TEMP_FILE=$(mktemp ${SBATCH_FILE}.flow.XXXX)
cp ${SBATCH_FILE} ${TEMP_FILE}

suffix=$( echo $TEMP_FILE | sed "s/.*\.\(flow.[0-9a-zA-Z]\{4\}$\)/\1/p" -n)

echo Creating submission file ${TEMP_FILE}

echo "Updating template..."
echo "sed -i "s/overwrite-suffix/${suffix}/" ${TEMP_FILE}"
sed -i "s/overwrite-suffix/${suffix}/" ${TEMP_FILE}
echo "sed -i "s/--output=overwrite-me/--output=${TEMP_FILE//\//\\\/}.out/" ${TEMP_FILE}"
sed -i "s/--output=overwrite-me/--output=${TEMP_FILE//\//\\\/}.out/" ${TEMP_FILE}
echo "sed -i "s/--error=overwrite-me/--error=${TEMP_FILE//\//\\\/}.err/" ${TEMP_FILE}"
sed -i "s/--error=overwrite-me/--error=${TEMP_FILE//\//\\\/}.err/" ${TEMP_FILE}
echo "sed -i "s/--account=overwrite-me/--account=${GPU_SLURM_ACCOUNT}/" ${TEMP_FILE}"
sed -i "s/--account=overwrite-me/--account=${GPU_SLURM_ACCOUNT}/" ${TEMP_FILE}
echo "done"

# Write prolog for resumability

cat >>${TEMP_FILE} <<'EOF'

# Prolog #

TIMEOUT_EXIT_CODE = 124
VERBOSE=true
WORKER_PIDS=""
SBATCH_TIMELIMIT=10740

# Command #

EOF

# Write command line

echo 'timeout -s TERM $(($SBATCH_TIMELIMIT - 60)) flow-execute '${CONTAINER} ${ARGUMENTS}' & WORKER_PIDS+=" $!"' >> ${TEMP_FILE}

# Write resumability code

cat >> ${TEMP_FILE} <<'EOL'

# Epilog #

NEED_TO_RESUME=false
if [ $VERBOSE = true ]; then
    echo NEED_TO_RESUME=$NEED_TO_RESUME
    echo WORKER_PIDS=$WORKER_PIDS
fi
for WORKER_PID in $WORKER_PIDS; do
    if [ $VERBOSE = true ]; then
        echo WORKER_PID=$WORKER_PID
    fi
    wait "$WORKER_PID"
    RETURN_CODE=$?
    if [ $VERBOSE = true ]; then
        echo "RETURN_CODE is $RETURN_CODE while timeout_exit_code is 124"
    fi
    if [ $RETURN_CODE -eq 124 ]; then
        NEED_TO_RESUME=true
    fi
    if [ $VERBOSE = true ]; then
        echo NEED_TO_RESUME=$NEED_TO_RESUME
    fi
done

if [ $VERBOSE = true ]; then
    echo NEED_TO_RESUME=$NEED_TO_RESUME
fi
EOL

cat >> ${TEMP_FILE} <<EOF

if [ "\$NEED_TO_RESUME" = true ]; then
    sbatch ${TEMP_FILE}
fi
EOF

# Submitting job

echo ${TEMP_FILE}
cat ${TEMP_FILE}
# sbatch ${TEMP_FILE}
